<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS ‚Äî AI Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080a0f;
    --surface: #0d1117;
    --surface2: #131924;
    --border: #1e2d40;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --warning: #f59e0b;
    --text: #e2eaf4;
    --muted: #6b7fa3;
    --danger: #ef4444;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }
  /* API Key overlay */
  #api-setup {
    position: fixed;
    inset: 0;
    z-index: 200;
    background: rgba(8,10,15,0.98);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    max-width: 460px;
    width: 92%;
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.4s ease;
  }
  .setup-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent2), var(--accent), var(--accent3));
  }
  .setup-logo {
    font-family: 'Syne', sans-serif;
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: 0.12em;
    margin-bottom: 6px;
  }
  .setup-card h2 {
    font-family: 'Syne', sans-serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 10px;
  }
  .setup-card p {
    color: var(--muted);
    font-size: 0.72rem;
    line-height: 1.8;
    margin-bottom: 24px;
  }
  .setup-card a { color: var(--accent); text-decoration: none; }
  .input-label {
    display: block;
    font-size: 0.62rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 7px;
    text-transform: uppercase;
  }
  .text-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 16px;
  }
  .text-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,255,0.08); }
  .btn-primary {
    width: 100%;
    padding: 13px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 8px;
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary:hover { box-shadow: 0 0 24px rgba(0,212,255,0.35); transform: translateY(-1px); }
  .error-msg {
    color: var(--danger);
    font-size: 0.68rem;
    margin-top: -10px;
    margin-bottom: 12px;
    display: none;
  }

  /* App Layout */
  header {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 13px 22px;
    border-bottom: 1px solid var(--border);
    background: rgba(8,10,15,0.92);
    backdrop-filter: blur(20px);
    flex-shrink: 0;
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.25rem;
    letter-spacing: 0.14em;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--accent);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.75)} }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .status-badge {
    display: flex; align-items: center; gap: 6px;
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    padding: 4px 10px; border-radius: 20px;
    color: var(--accent3); font-size: 0.62rem; letter-spacing: 0.08em;
  }
  .status-dot { width:5px;height:5px;border-radius:50%;background:var(--accent3);box-shadow:0 0 6px var(--accent3);animation:pulse 2s infinite; }
  .api-reset-btn {
    background: transparent; border: 1px solid var(--border);
    color: var(--muted); font-family: 'Space Mono', monospace;
    font-size: 0.62rem; padding: 4px 10px; border-radius: 6px;
    cursor: pointer; transition: all 0.15s; letter-spacing: 0.05em;
  }
  .api-reset-btn:hover { border-color: var(--danger); color: var(--danger); }

  .main { position: relative; z-index: 1; display: flex; flex: 1; overflow: hidden; }

  /* Sidebar */
  .sidebar {
    width: 210px;
    background: rgba(13,17,23,0.85);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    padding: 14px 10px;
    gap: 3px; flex-shrink: 0;
  }
  .sidebar-section {
    font-size: 0.58rem; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--muted);
    padding: 10px 8px 5px; margin-top: 4px;
  }
  .tool-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 10px; border-radius: 7px;
    cursor: pointer; font-family: 'Space Mono', monospace;
    font-size: 0.7rem; color: var(--muted);
    transition: all 0.15s; border: 1px solid transparent;
    background: transparent; text-align: left; width: 100%;
  }
  .tool-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border); }
  .tool-btn.active { background: rgba(0,212,255,0.08); color: var(--accent); border-color: rgba(0,212,255,0.2); }
  .tool-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }
  .sidebar-divider { height: 1px; background: var(--border); margin: 10px 0; }
  .clear-btn {
    margin-top: auto; padding: 9px 10px;
    background: transparent; border: 1px solid var(--border);
    border-radius: 7px; color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 0.7rem;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .clear-btn:hover { border-color: var(--danger); color: var(--danger); }

  /* Chat */
  .chat-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .messages {
    flex: 1; overflow-y: auto;
    padding: 24px 28px;
    display: flex; flex-direction: column; gap: 20px;
    scroll-behavior: smooth;
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Welcome */
  .welcome {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; height: 100%; text-align: center; gap: 18px;
    opacity: 0; animation: fadeIn 0.6s 0.1s forwards;
  }
  @keyframes fadeIn { to { opacity: 1; } }
  .welcome-icon {
    font-size: 3.2rem;
    filter: drop-shadow(0 0 24px rgba(0,212,255,0.5));
    animation: float 3.5s ease-in-out infinite;
  }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
  .welcome h2 {
    font-family: 'Syne', sans-serif; font-size: 1.8rem; font-weight: 800;
    background: linear-gradient(135deg, var(--text) 30%, var(--accent));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .welcome p { color: var(--muted); font-size: 0.75rem; max-width: 360px; line-height: 1.8; }
  .suggestion-chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-width: 500px; }
  .chip {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 7px 14px;
    font-size: 0.68rem; color: var(--muted);
    cursor: pointer; transition: all 0.2s;
    font-family: 'Space Mono', monospace;
  }
  .chip:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,212,255,0.06); }

  /* Messages */
  .msg { display: flex; gap: 12px; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .msg.user { flex-direction: row-reverse; }
  .msg-avatar {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.9rem; flex-shrink: 0; align-self: flex-start;
  }
  .msg.user .msg-avatar { background: linear-gradient(135deg, var(--accent2), var(--accent)); }
  .msg.agent .msg-avatar { background: var(--surface2); border: 1px solid var(--border); }
  .msg-content { max-width: 74%; display: flex; flex-direction: column; gap: 5px; }
  .msg.user .msg-content { align-items: flex-end; }
  .mode-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 0.58rem; letter-spacing: 0.08em;
    padding: 2px 8px; border-radius: 4px; text-transform: uppercase;
  }
  .mode-badge.code { background: rgba(124,58,237,0.15); color: var(--accent2); border: 1px solid rgba(124,58,237,0.3); }
  .mode-badge.data { background: rgba(16,185,129,0.12); color: var(--accent3); border: 1px solid rgba(16,185,129,0.3); }
  .mode-badge.trade { background: rgba(245,158,11,0.12); color: var(--warning); border: 1px solid rgba(245,158,11,0.3); }
  .mode-badge.general { background: rgba(0,212,255,0.1); color: var(--accent); border: 1px solid rgba(0,212,255,0.2); }
  .msg-bubble {
    padding: 12px 16px; border-radius: 12px;
    font-size: 0.76rem; line-height: 1.75;
    white-space: pre-wrap; word-break: break-word;
    max-width: 100%;
  }
  .msg.user .msg-bubble {
    background: linear-gradient(135deg, rgba(124,58,237,0.22), rgba(0,212,255,0.12));
    border: 1px solid rgba(0,212,255,0.18); color: var(--text);
    border-radius: 12px 4px 12px 12px;
  }
  .msg.agent .msg-bubble {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    border-radius: 4px 12px 12px 12px;
  }
  .msg-bubble code {
    background: rgba(0,0,0,0.45); padding: 1px 6px;
    border-radius: 4px; font-family: 'Space Mono', monospace;
    font-size: 0.85em; color: var(--accent);
  }
  .msg-bubble pre {
    background: rgba(0,0,0,0.5); border: 1px solid var(--border);
    border-radius: 8px; padding: 14px; overflow-x: auto; margin-top: 10px;
  }
  .msg-bubble pre code {
    background: transparent; padding: 0;
    color: var(--accent3); font-size: 0.73rem; line-height: 1.65;
  }
  .msg-time { font-size: 0.58rem; color: var(--muted); letter-spacing: 0.05em; }

  /* Typing */
  .typing {
    display: flex; gap: 4px; align-items: center;
    padding: 12px 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 12px; width: fit-content;
  }
  .typing-dot {
    width: 6px; height: 6px; background: var(--accent);
    border-radius: 50%; animation: typingBounce 1.2s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce { 0%,80%,100%{transform:scale(0.6);opacity:0.4} 40%{transform:scale(1);opacity:1} }

  /* Input area */
  .input-area {
    padding: 14px 22px 18px;
    border-top: 1px solid var(--border);
    background: rgba(8,10,15,0.92);
    backdrop-filter: blur(20px);
    flex-shrink: 0;
  }
  .mode-selector { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
  .mode-tab {
    padding: 5px 11px; border-radius: 6px;
    font-family: 'Space Mono', monospace; font-size: 0.63rem;
    letter-spacing: 0.05em; cursor: pointer;
    border: 1px solid var(--border); background: transparent;
    color: var(--muted); transition: all 0.15s;
    display: flex; align-items: center; gap: 5px;
  }
  .mode-tab:hover { color: var(--text); border-color: var(--muted); }
  .mode-tab.active-general { background: rgba(0,212,255,0.1); color: var(--accent); border-color: rgba(0,212,255,0.35); }
  .mode-tab.active-code { background: rgba(124,58,237,0.15); color: var(--accent2); border-color: rgba(124,58,237,0.4); }
  .mode-tab.active-data { background: rgba(16,185,129,0.12); color: var(--accent3); border-color: rgba(16,185,129,0.4); }
  .mode-tab.active-trade { background: rgba(245,158,11,0.12); color: var(--warning); border-color: rgba(245,158,11,0.4); }
  .input-row { display: flex; gap: 10px; align-items: flex-end; }
  .chat-input {
    flex: 1; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px;
    color: var(--text); font-family: 'Space Mono', monospace;
    font-size: 0.76rem; outline: none; resize: none;
    min-height: 46px; max-height: 140px; line-height: 1.5;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .chat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,255,0.08); }
  .chat-input::placeholder { color: var(--muted); }
  .send-btn {
    width: 46px; height: 46px; background: var(--accent);
    border: none; border-radius: 10px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; transition: all 0.2s; flex-shrink: 0; color: var(--bg);
  }
  .send-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,212,255,0.4); }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

  /* Right Panel */
  .right-panel {
    width: 250px; flex-shrink: 0;
    background: rgba(13,17,23,0.85);
    border-left: 1px solid var(--border);
    display: flex; flex-direction: column; overflow-y: auto;
  }
  .panel-header {
    padding: 14px 16px 10px;
    font-size: 0.6rem; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--muted);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .info-card {
    margin: 12px; padding: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px;
  }
  .info-card-title {
    font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 8px;
    display: flex; align-items: center; gap: 6px;
  }
  .info-card p { font-size: 0.68rem; color: var(--text); line-height: 1.6; }
  .capability-list { display: flex; flex-direction: column; gap: 6px; }
  .cap-item {
    display: flex; align-items: flex-start; gap: 8px;
    font-size: 0.67rem; color: var(--muted); line-height: 1.4;
  }
  .cap-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
  .cap-dot.code { background: var(--accent2); box-shadow: 0 0 5px var(--accent2); }
  .cap-dot.data { background: var(--accent3); box-shadow: 0 0 5px var(--accent3); }
  .cap-dot.trade { background: var(--warning); box-shadow: 0 0 5px var(--warning); }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stat-item { text-align: center; }
  .stat-value { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: 0.58rem; color: var(--muted); letter-spacing: 0.05em; }
  .disclaimer {
    margin: 0 12px 12px;
    padding: 10px;
    background: rgba(245,158,11,0.07);
    border: 1px solid rgba(245,158,11,0.2);
    border-radius: 8px;
    font-size: 0.62rem; color: var(--warning); line-height: 1.6;
  }
  .disclaimer strong { display: block; margin-bottom: 4px; }

  @media (max-width: 900px) { .right-panel { display: none; } }
  @media (max-width: 640px) { .sidebar { display: none; } }
</style>
</head>
<body>

<!-- API Key Setup -->
<div id="api-setup">
  <div class="setup-card">
    <div class="setup-logo">NEXUS</div>
    <h2>Connect Your AI Agent</h2>
    <p>
      Enter your Anthropic API key to power NEXUS. Your key is stored only in your browser's local memory and never sent anywhere except directly to Anthropic's API.<br><br>
      Don't have a key? Get one at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
    </p>
    <label class="input-label">Anthropic API Key</label>
    <input type="password" class="text-input" id="api-key-input" placeholder="sk-ant-..." />
    <div class="error-msg" id="key-error">‚ö† Invalid key format. Should start with "sk-ant-"</div>
    <button class="btn-primary" onclick="saveApiKey()">Launch Agent ‚Üí</button>
  </div>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-dot"></div>
    NEXUS
  </div>
  <div class="header-right">
    <div class="status-badge">
      <div class="status-dot"></div>
      ONLINE
    </div>
    <button class="api-reset-btn" onclick="resetApiKey()">‚öô Reset Key</button>
  </div>
</header>

<!-- Main -->
<div class="main">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-section">Agent Mode</div>
    <button class="tool-btn active" onclick="setMode('general')" id="btn-general">
      <span class="tool-icon">ü§ñ</span> General
    </button>
    <button class="tool-btn" onclick="setMode('code')" id="btn-code">
      <span class="tool-icon">üíª</span> Code
    </button>
    <button class="tool-btn" onclick="setMode('data')" id="btn-data">
      <span class="tool-icon">üìä</span> Data Analysis
    </button>
    <button class="tool-btn" onclick="setMode('trade')" id="btn-trade">
      <span class="tool-icon">üìà</span> Trading
    </button>

    <div class="sidebar-divider"></div>
    <div class="sidebar-section">Quick Tasks</div>
    <button class="tool-btn" onclick="quickPrompt('Write a Python script to fetch stock prices using the yfinance library for AAPL, TSLA, and MSFT and print them in a table.')">
      <span class="tool-icon">üîß</span> Stock Script
    </button>
    <button class="tool-btn" onclick="quickPrompt('Explain moving average crossover strategy in trading. Give me a Python example with buy/sell signal logic.')">
      <span class="tool-icon">üìâ</span> MA Strategy
    </button>
    <button class="tool-btn" onclick="quickPrompt('Write Python code to analyse a CSV dataset: load it with pandas, show summary statistics, identify missing values, and print insights.')">
      <span class="tool-icon">üîç</span> Analyse CSV
    </button>
    <button class="tool-btn" onclick="quickPrompt('What are the most important technical indicators for day trading? Explain RSI, MACD, and Bollinger Bands simply.')">
      <span class="tool-icon">üìö</span> Indicators 101
    </button>

    <div class="sidebar-divider"></div>
    <button class="clear-btn" onclick="clearChat()">üóë Clear Chat</button>
  </div>

  <!-- Chat -->
  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <div class="welcome-icon">ü§ñ</div>
        <h2>NEXUS Agent Ready</h2>
        <p>Your autonomous AI assistant for code writing, data analysis, and trading strategy. Ask me anything or pick a mode.</p>
        <div class="suggestion-chips">
          <div class="chip" onclick="useChip(this)">Write a Python trading bot</div>
          <div class="chip" onclick="useChip(this)">Explain RSI indicator</div>
          <div class="chip" onclick="useChip(this)">Analyse sample stock data</div>
          <div class="chip" onclick="useChip(this)">Backtest a strategy</div>
          <div class="chip" onclick="useChip(this)">Write a data pipeline</div>
          <div class="chip" onclick="useChip(this)">Portfolio risk analysis</div>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="input-area">
      <div class="mode-selector">
        <button class="mode-tab active-general" onclick="setMode('general')" id="tab-general">ü§ñ General</button>
        <button class="mode-tab" onclick="setMode('code')" id="tab-code">üíª Code</button>
        <button class="mode-tab" onclick="setMode('data')" id="tab-data">üìä Data</button>
        <button class="mode-tab" onclick="setMode('trade')" id="tab-trade">üìà Trading</button>
      </div>
      <div class="input-row">
        <textarea
          class="chat-input"
          id="chat-input"
          placeholder="Ask your agent anything‚Ä¶ (Shift+Enter for new line)"
          rows="1"
        ></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <div class="panel-header">Agent Info</div>

    <div class="info-card" style="margin-top:14px">
      <div class="info-card-title">üìä Session Stats</div>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-value" id="msg-count">0</div>
          <div class="stat-label">Messages</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="mode-display">GEN</div>
          <div class="stat-label">Mode</div>
        </div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-card-title">‚ö° Capabilities</div>
      <div class="capability-list">
        <div class="cap-item">
          <div class="cap-dot code"></div>
          Write, explain & debug Python, JavaScript, SQL and more
        </div>
        <div class="cap-item">
          <div class="cap-dot data"></div>
          Analyse data, build pandas pipelines, visualise insights
        </div>
        <div class="cap-item">
          <div class="cap-dot trade"></div>
          Trading strategies, indicators, backtesting logic & risk models
        </div>
      </div>
    </div>

    <div class="info-card">
      <div class="info-card-title">üí° Tips</div>
      <p style="font-size:0.66rem;color:var(--muted);line-height:1.7">
        ‚Ä¢ Use <strong style="color:var(--text)">Code mode</strong> for clean, runnable scripts<br>
        ‚Ä¢ Use <strong style="color:var(--text)">Trading mode</strong> for market strategy help<br>
        ‚Ä¢ Use <strong style="color:var(--text)">Data mode</strong> for analysis & pandas help<br>
        ‚Ä¢ Paste your data or errors directly into the chat
      </p>
    </div>

    <div class="disclaimer">
      <strong>‚ö† Disclaimer</strong>
      Trading information is for educational purposes only. Always do your own research. This is not financial advice.
    </div>
  </div>

</div>

<script>
  // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let apiKey = '';
  let currentMode = 'general';
  let conversation = [];
  let msgCount = 0;
  let isLoading = false;

  const systemPrompts = {
    general: `You are NEXUS, a highly capable autonomous AI agent. You help with a wide range of tasks including coding, data analysis, and trading. Be direct, clear, and thorough. Format code in markdown code blocks with language labels.`,

    code: `You are NEXUS in Code Mode ‚Äî an expert software engineer. When asked to write code:
- Always use the correct language (default Python unless asked otherwise)
- Wrap code in markdown code blocks with the language label (e.g. \`\`\`python)
- Include comments and explain what the code does
- Handle errors gracefully and write clean, readable code
- If writing a trading or finance script, use libraries like yfinance, pandas, numpy
Be concise but complete.`,

    data: `You are NEXUS in Data Analysis Mode ‚Äî a senior data analyst and data scientist.
- Help with pandas, numpy, matplotlib, seaborn, plotly
- When showing code, always use markdown code blocks with \`\`\`python
- Explain your analysis step by step
- Suggest visualizations where useful
- If given raw data, extract insights and patterns
Be analytical and precise.`,

    trade: `You are NEXUS in Trading Mode ‚Äî an expert quantitative analyst and trading strategist.
- Explain technical indicators (RSI, MACD, EMA, Bollinger Bands, etc.) clearly
- Provide Python code examples using yfinance, pandas, ta-lib or similar
- Explain trading strategies with entry/exit logic
- Always include risk management considerations
- Wrap all code in \`\`\`python code blocks
IMPORTANT: Always remind users this is for educational purposes only, not financial advice.`
  };

  const modeLabels = { general:'GEN', code:'CODE', data:'DATA', trade:'TRADE' };
  const modeBadgeText = { general:'ü§ñ General', code:'üíª Code', data:'üìä Data', trade:'üìà Trading' };
  const placeholders = {
    general: 'Ask your agent anything‚Ä¶ (Shift+Enter for new line)',
    code: 'Describe the code you need‚Ä¶ e.g. "Write a Python script to scrape stock data"',
    data: 'Ask a data question‚Ä¶ e.g. "Analyse this CSV and find outliers"',
    trade: 'Ask a trading question‚Ä¶ e.g. "Explain MACD and give me a Python example"'
  };

  // ‚îÄ‚îÄ‚îÄ API Key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveApiKey() {
    const input = document.getElementById('api-key-input').value.trim();
    const errEl = document.getElementById('key-error');
    if (!input.startsWith('sk-ant-') && !input.startsWith('sk-')) {
      errEl.style.display = 'block';
      return;
    }
    errEl.style.display = 'none';
    apiKey = input;
    sessionStorage.setItem('nexus_key', apiKey);
    document.getElementById('api-setup').style.display = 'none';
  }

  function resetApiKey() {
    sessionStorage.removeItem('nexus_key');
    apiKey = '';
    document.getElementById('api-key-input').value = '';
    document.getElementById('api-setup').style.display = 'flex';
  }

  // Load saved key
  window.addEventListener('load', () => {
    const saved = sessionStorage.getItem('nexus_key');
    if (saved) { apiKey = saved; document.getElementById('api-setup').style.display = 'none'; }

    const input = document.getElementById('chat-input');
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 140) + 'px';
    });
    document.getElementById('api-key-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') saveApiKey();
    });
  });

  // ‚îÄ‚îÄ‚îÄ Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setMode(mode) {
    currentMode = mode;
    // Sidebar buttons
    ['general','code','data','trade'].forEach(m => {
      document.getElementById('btn-'+m).classList.toggle('active', m === mode);
      const tab = document.getElementById('tab-'+m);
      tab.className = 'mode-tab';
      if (m === mode) tab.classList.add('active-'+m);
    });
    document.getElementById('chat-input').placeholder = placeholders[mode];
    document.getElementById('mode-display').textContent = modeLabels[mode];
  }

  // ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function clearChat() {
    conversation = [];
    msgCount = 0;
    document.getElementById('msg-count').textContent = '0';
    const msgs = document.getElementById('messages');
    msgs.innerHTML = `
      <div class="welcome" id="welcome">
        <div class="welcome-icon">ü§ñ</div>
        <h2>NEXUS Agent Ready</h2>
        <p>Your autonomous AI assistant for code writing, data analysis, and trading strategy.</p>
        <div class="suggestion-chips">
          <div class="chip" onclick="useChip(this)">Write a Python trading bot</div>
          <div class="chip" onclick="useChip(this)">Explain RSI indicator</div>
          <div class="chip" onclick="useChip(this)">Analyse sample stock data</div>
          <div class="chip" onclick="useChip(this)">Backtest a strategy</div>
          <div class="chip" onclick="useChip(this)">Write a data pipeline</div>
          <div class="chip" onclick="useChip(this)">Portfolio risk analysis</div>
        </div>
      </div>`;
  }

  function useChip(el) { document.getElementById('chat-input').value = el.textContent; sendMessage(); }
  function quickPrompt(text) { document.getElementById('chat-input').value = text; sendMessage(); }

  function hideWelcome() {
    const w = document.getElementById('welcome');
    if (w) w.remove();
  }

  function addMessage(role, content, mode) {
    hideWelcome();
    const msgs = document.getElementById('messages');
    const now = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    const div = document.createElement('div');
    div.className = `msg ${role}`;

    const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
    const badge = role === 'agent'
      ? `<div class="mode-badge ${mode || 'general'}">${modeBadgeText[mode || 'general']}</div>` : '';

    div.innerHTML = `
      <div class="msg-avatar">${avatar}</div>
      <div class="msg-content">
        ${badge}
        <div class="msg-bubble">${formatMessage(content)}</div>
        <div class="msg-time">${now}</div>
      </div>`;

    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    msgCount++;
    document.getElementById('msg-count').textContent = msgCount;
    return div;
  }

  function formatMessage(text) {
    // Escape HTML first
    let escaped = text
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // Code blocks
    escaped = escaped.replace(/```(\w+)?\n?([\s\S]*?)```/g, (_, lang, code) => {
      return `<pre><code>${code.trim()}</code></pre>`;
    });

    // Inline code
    escaped = escaped.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Bold
    escaped = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Line breaks
    escaped = escaped.replace(/\n/g, '<br>');

    return escaped;
  }

  function addTyping() {
    hideWelcome();
    const msgs = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg agent';
    div.id = 'typing-indicator';
    div.innerHTML = `
      <div class="msg-avatar">ü§ñ</div>
      <div class="msg-content">
        <div class="typing">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>`;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
  }

  function removeTyping() {
    const t = document.getElementById('typing-indicator');
    if (t) t.remove();
  }

  async function sendMessage() {
    if (isLoading) return;
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;
    if (!apiKey) { alert('Please enter your API key first.'); resetApiKey(); return; }

    input.value = '';
    input.style.height = 'auto';
    isLoading = true;
    document.getElementById('send-btn').disabled = true;

    addMessage('user', text);
    conversation.push({ role: 'user', content: text });

    const typingEl = addTyping();

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4096,
          system: systemPrompts[currentMode],
          messages: conversation
        })
      });

      removeTyping();

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        const errMsg = err.error?.message || `Error ${response.status}`;
        addMessage('agent', `‚ö†Ô∏è API Error: ${errMsg}\n\nPlease check your API key or try again.`, currentMode);
        conversation.pop();
      } else {
        const data = await response.json();
        const reply = data.content[0]?.text || '(no response)';
        conversation.push({ role: 'assistant', content: reply });
        addMessage('agent', reply, currentMode);
      }
    } catch (err) {
      removeTyping();
      addMessage('agent', `‚ö†Ô∏è Network Error: ${err.message}\n\nMake sure you're connected to the internet.`, currentMode);
      conversation.pop();
    }

    isLoading = false;
    document.getElementById('send-btn').disabled = false;
    input.focus();
  }
</script>
</body>
</html>
